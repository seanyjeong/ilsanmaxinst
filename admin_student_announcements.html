<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>í•™ìƒ ê³µì§€ì‚¬í•­ ê´€ë¦¬ (ê´€ë¦¬ì)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ê¸°ì¡´ ê´€ë¦¬ì í˜ì´ì§€ ìŠ¤íƒ€ì¼ ë³€ìˆ˜ ì¬í™œìš© */
        :root {
            --primary-color: #2563eb; --primary-dark:#1d4ed8;
            --light-bg: #f8fafc; --card-bg: #ffffff;
            --border-color: #e2e8f0; --text-primary:#1e293b; --text-secondary:#475569;
            --danger-color: #ef4444; --success-color: #10b981; --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light-bg); padding: 20px; margin: 0; line-height: 1.5; color: var(--text-primary); }
        .container { max-width: 900px; margin: 0 auto; }

        /* ---------- Header ---------- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            gap: 12px; flex-wrap: wrap;
            background: var(--card-bg); padding: 16px 18px; border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.6rem; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: none; border-radius: 8px; font-weight: 600; font-size: .9rem; cursor: pointer; transition: .2s; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; }
        .btn-danger { background: var(--danger-color); color: #fff; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: #e2e8f0; color: var(--text-secondary); }
        .btn-secondary:hover { background: #cbd5e1; }

        /* ---------- Card ---------- */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
        .card-title { font-size: 1.3rem; font-weight: 600; margin: 0 0 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }

        /* í¼ ìš”ì†Œ */
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .form-group label { font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary); }
        .form-group input[type="text"], .form-group select, .form-group textarea {
            width: 100%; padding: 10px; font-size: 0.95rem;
            border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Pretendard', sans-serif;
        }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }

        /* ê³µì§€ì‚¬í•­ ëª©ë¡ */
        #announcementList { list-style: none; padding: 0; margin: 0; }
        .announcement-item {
            background: #f8fafc; border: 1px solid var(--border-color);
            border-radius: 8px; padding: 15px; margin-bottom: 15px;
        }
        .announcement-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed var(--border-color);
        }
        .announcement-title { font-size: 1.1rem; font-weight: 600; margin: 0; flex-grow: 1; }
        .announcement-meta { font-size: 0.8rem; color: var(--text-secondary); text-align: right; white-space: nowrap; margin-left: 15px; }
        .announcement-meta .branch { font-weight: 600; color: var(--primary-color); display: block; }
        .announcement-meta .date { display: block; margin-top: 3px; }
        .announcement-content { font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap; word-break: break-word; margin-bottom: 15px; }
        .announcement-actions { display: flex; justify-content: flex-end; gap: 8px; }

        /* ë¡œë”©/ë°ì´í„° ì—†ìŒ */
        .loading, .no-data { text-align: center; padding: 30px; color: var(--text-secondary); }

        /* --- Toast Popup --- */
        .toast-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8); color: white; padding: 10px 18px; border-radius: 20px;
            font-size: 0.9rem; z-index: 1002; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
            pointer-events: none;
        }
        .toast-popup.show { opacity: 1; bottom: 40px; }
        .toast-popup.success { background-color: var(--success-color); }
        .toast-popup.error { background-color: var(--danger-color); }

        /* --- ëª¨ë°”ì¼ ë°˜ì‘í˜• --- */
        @media (max-width: 767px) {
            body { padding: 10px; }
            .header { flex-direction: column; align-items: stretch; padding: 15px; }
            .header h1 { font-size: 1.4rem; }
            .btn { justify-content: center; }
            .card { padding: 15px; }
            .announcement-header { flex-direction: column; align-items: stretch; }
            .announcement-meta { text-align: left; margin-left: 0; margin-top: 8px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-bullhorn"></i> í•™ìƒ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h1>
        </div>

    <div class="card" id="announcementFormCard">
        <h4 class="card-title" id="formTitle">ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„±</h4>
        <input type="hidden" id="editingNoticeId"> <div class="form-group">
            <label for="noticeTitle">ì œëª© (í•„ìˆ˜)</label>
            <input type="text" id="noticeTitle" placeholder="ê³µì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="form-group">
            <label for="noticeContent">ë‚´ìš©</label>
            <textarea id="noticeContent" rows="5" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
        <div class="form-group">
            <label for="noticeBranch">ëŒ€ìƒ ì§€ì </label>
            <select id="noticeBranch">
                <option value="">- ì „ì²´ í•™ìƒ -</option>
                </select>
        </div>
        <div class="form-actions">
            <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display: none;">ì·¨ì†Œ</button>
            <button type="button" id="saveNoticeBtn" class="btn btn-primary">
                <i class="fas fa-save"></i> ì €ì¥í•˜ê¸°
            </button>
        </div>
    </div>

    <div class="card">
        <h4 class="card-title">ê³µì§€ ëª©ë¡</h4>
        <div id="announcementList">
            <p class="loading" id="listLoading"><i class="fas fa-spinner fa-spin"></i> ëª©ë¡ ë¡œë”© ì¤‘...</p>
        </div>
    </div>
</div>

<template id="announcementItemTemplate">
    <div class="announcement-item" data-notice-id="{{notice_id}}">
        <div class="announcement-header">
            <h5 class="announcement-title">ê³µì§€ ì œëª©</h5>
            <div class="announcement-meta">
                <span class="branch">ëŒ€ìƒ: ì „ì²´</span>
                <span class="date">ì‘ì„±ì¼: YYYY-MM-DD HH:MM</span>
                <span class="author" style="font-size: 0.75rem;">(ì‘ì„±ì: ì•„ì´ë””)</span>
            </div>
        </div>
        <div class="announcement-content">
            ê³µì§€ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
        </div>
        <div class="announcement-actions">
            <button type="button" class="btn btn-secondary btn-sm edit-btn">
                <i class="fas fa-edit"></i> ìˆ˜ì •
            </button>
            <button type="button" class="btn btn-danger btn-sm delete-btn">
                <i class="fas fa-trash"></i> ì‚­ì œ
            </button>
        </div>
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ì„œë²„ ë° ì¸ì¦ ---
        const SVR_JUNGSI = 'https://supermax.kr'; // jungsi ì„œë²„
        const LOGIN_PAGE = 'admin_login.html'; // ê´€ë¦¬ì ë¡œê·¸ì¸ í˜ì´ì§€

        // --- HTML ìš”ì†Œ ---
        const announcementFormCard = document.getElementById('announcementFormCard');
        const formTitle = document.getElementById('formTitle');
        const editingNoticeId = document.getElementById('editingNoticeId');
        const noticeTitle = document.getElementById('noticeTitle');
        const noticeContent = document.getElementById('noticeContent');
        const noticeBranch = document.getElementById('noticeBranch');
        const saveNoticeBtn = document.getElementById('saveNoticeBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const announcementList = document.getElementById('announcementList');
        const listLoading = document.getElementById('listLoading');

        let currentUser = null; // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´
        let branchList = []; // ì§€ì  ëª©ë¡

        // --- ì¸ì¦ í™•ì¸ ---
        const getToken = () => localStorage.getItem('jwt_token');
        const token = getToken();
        if (!token) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); window.location.href = LOGIN_PAGE; return; }
        try {
            const payloadBase64Url = token.split('.')[1];
            const payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
            const decodedString = new TextDecoder().decode(Uint8Array.from(atob(payloadBase64), c => c.charCodeAt(0)));
            currentUser = JSON.parse(decodedString);
            console.log("ë¡œê·¸ì¸ ì‚¬ìš©ì:", currentUser);
            // í˜ì´ì§€ ìì²´ ì ‘ê·¼ ê¶Œí•œ ì²´í¬ëŠ” í˜ì´ì§€ë³„ë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì œê±°.
            // í•„ìš”í•˜ë‹¤ë©´ ë‹¤ì‹œ ì¶”ê°€:
            // if (currentUser.role !== 'admin' && currentUser.userid !== 'sean8320') {
            //     alert('ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            //     window.location.href = LOGIN_PAGE;
            //     return;
            // }
        } catch (e) {
            console.error('í† í° ì²˜ë¦¬ ì‹¤íŒ¨:', e); alert('ì¸ì¦ ì •ë³´ ì˜¤ë¥˜.'); window.location.href = LOGIN_PAGE; return;
        }

        // --- API í˜¸ì¶œ í•¨ìˆ˜ (ì¸ì¦ í¬í•¨, 403 ì²˜ë¦¬ ìˆ˜ì •) ---
        const apiCall = async (url, options = {}) => {
            const currentToken = getToken();
            if (!currentToken) { alert('ë¡œê·¸ì¸ ì„¸ì…˜ ë§Œë£Œ'); window.location.href = LOGIN_PAGE; throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ'); }
            options.headers = { ...options.headers, 'Authorization': `Bearer ${currentToken}` };
            try {
                const response = await fetch(url, options);
                // â­ï¸ 403 Forbidden ì—ëŸ¬ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰ì…˜ ë°©ì§€ (ê¶Œí•œ ì—†ìŒ ë©”ì‹œì§€ë§Œ)
                if (response.status === 401) { // 401 Unauthorized (í† í° ë§Œë£Œ ë“±)
                     alert('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                     localStorage.removeItem('jwt_token');
                     window.location.href = LOGIN_PAGE;
                     throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ');
                } else if (response.status === 403) { // 403 Forbidden (ê¶Œí•œ ì—†ìŒ)
                     alert('ì´ ê¸°ëŠ¥ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); // ë©”ì‹œì§€ë§Œ ë³´ì—¬ì¤Œ
                     throw new Error('ê¶Œí•œ ì—†ìŒ'); // ì—ëŸ¬ ë°œìƒì‹œì¼œ ë¡œì§ ì¤‘ë‹¨
                }
                if (!response.ok) {
                    let errorMsg = `HTTP ì˜¤ë¥˜ ${response.status}`; try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch (_) {} throw new Error(errorMsg);
                }
                if (response.status === 204) { return { success: true }; } // DELETE ì„±ê³µ ì‹œ
                 return await response.json(); // 200, 201 ë“±
            } catch (error) {
                console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', url, error);
                // â­ï¸ ë¡œê·¸ì¸ ë§Œë£Œ/ê¶Œí•œ ì—†ìŒ ì™¸ ë‹¤ë¥¸ ì—ëŸ¬ë§Œ throw í•˜ë„ë¡ ìˆ˜ì •
                if (error.message !== 'ë¡œê·¸ì¸ ë§Œë£Œ' && error.message !== 'ê¶Œí•œ ì—†ìŒ') {
                    // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“± ë‹¤ë¥¸ ì—ëŸ¬ ë°œìƒ ì‹œ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
                    showToast(`ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜: ${error.message}`, false);
                    throw new Error(error.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
                }
                // ë¡œê·¸ì¸ ë§Œë£Œ/ê¶Œí•œ ì—†ìŒ ì—ëŸ¬ëŠ” alertê°€ ì´ë¯¸ ë–´ìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ throw (í˜¸ì¶œí•œ ìª½ì—ì„œ catch ë¶ˆí•„ìš”)
                throw error;
            }
        };


        // --- Toast Popup í•¨ìˆ˜ ---
        const showToast = (message, isSuccess = true) => {
            const el = document.createElement('div'); el.textContent = message; el.className = `toast-popup ${isSuccess ? 'success' : 'error'}`; document.body.appendChild(el); setTimeout(() => el.classList.add('show'), 10); setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 2500);
        };

        // --- ë‚ ì§œ í¬ë§·íŒ… í—¬í¼ ---
        const formatDateTime = (isoString) => {
            if (!isoString) return ''; try { const date = new Date(isoString); return date.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(/\. /g, '-').replace('.', ''); } catch (e) { return isoString; }
        };

        // --- ê´€ë¦¬ìì¸ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜ ---
        const isAdminUser = () => {
            return currentUser && (currentUser.role === 'admin' || currentUser.userid === 'sean8320');
        }

        // --- 1. ì§€ì  ëª©ë¡ ë¡œë“œ (ëŒ€ìƒ ì§€ì  ì„ íƒìš© - ì—­í• ì— ë”°ë¼ ë¶„ê¸°) ---
const loadBranches = () => {
            // currentUser ê°ì²´ëŠ” í˜ì´ì§€ ìƒë‹¨ì—ì„œ ì´ë¯¸ ì •ì˜ë¨
            const loggedInBranch = currentUser ? currentUser.branch : null;

            console.log('loadBranches: Using logged-in user branch:', loggedInBranch);

            // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
            noticeBranch.innerHTML = '<option value="">- ì „ì²´ í•™ìƒ -</option>'; // ê¸°ë³¸ê°’: ì „ì²´

            if (loggedInBranch) {
                // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì§€ì  ì •ë³´ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì§€ì ë§Œ ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€
                const option = document.createElement('option');
                option.value = loggedInBranch;
                option.textContent = loggedInBranch;
                noticeBranch.appendChild(option);
                console.log(` -> Added option for branch: ${loggedInBranch}`);
                branchList = [loggedInBranch]; // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (í•„ìš” ì‹œ)
                noticeBranch.disabled = false; // ë“œë¡­ë‹¤ìš´ í™œì„±í™” (ì „ì²´ ë˜ëŠ” ìê¸° ì§€ì  ì„ íƒ ê°€ëŠ¥)
            } else {
                // í† í°ì— ì§€ì  ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° (ì˜ˆ: ìµœìƒìœ„ ê´€ë¦¬ì ê³„ì • ë“±)
                console.warn(' -> Logged-in user has no branch information. Only "ì „ì²´ í•™ìƒ" available.');
                branchList = [];
                // noticeBranch.disabled = true; // ì´ ê²½ìš° ì„ íƒ ëª»í•˜ê²Œ í•  ìˆ˜ë„ ìˆìŒ (ì„ íƒ)
            }
        };

        // --- 2. ê³µì§€ì‚¬í•­ ëª©ë¡ ë¡œë“œ ë° ë Œë”ë§ ---
        const loadAnnouncements = async () => {
            listLoading.style.display = 'block';
            announcementList.innerHTML = '';
            announcementList.appendChild(listLoading);

            try {
                // API í˜¸ì¶œ (authMiddleware ì‚¬ìš© - ëª¨ë“  ë¡œê·¸ì¸ ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥)
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/student/announcements`);

                listLoading.style.display = 'none';

                if (data.success && data.announcements) {
                    if (data.announcements.length === 0) {
                        announcementList.innerHTML = '<p class="no-data">ì‘ì„±ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }
                    data.announcements.forEach(notice => {
                        const item = createAnnouncementItem(notice);
                        announcementList.appendChild(item);
                    });
                } else {
                    announcementList.innerHTML = `<p class="no-data">ê³µì§€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${data.message || 'ì˜¤ë¥˜'}</p>`;
                }
            } catch (err) {
                 listLoading.style.display = 'none';
                 // apiCall ë‚´ë¶€ì—ì„œ alertë¥¼ ë„ìš°ê±°ë‚˜ ë¦¬ë‹¤ì´ë ‰ì…˜í•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì¶”ê°€ ë™ì‘ ë¶ˆí•„ìš”
                 console.error('loadAnnouncements error caught:', err.message); // ì½˜ì†”ì—ë§Œ ê¸°ë¡
                 // í•„ìš”í•œ ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ:
                 // if (err.message !== 'ê¶Œí•œ ì—†ìŒ' && err.message !== 'ë¡œê·¸ì¸ ë§Œë£Œ') {
                 //     announcementList.innerHTML = `<p class="no-data">ì˜¤ë¥˜ ë°œìƒ: ${err.message}</p>`;
                 // }
            }
        };

        // --- 2-1. ê°œë³„ ê³µì§€ í•­ëª© ìƒì„± í•¨ìˆ˜ ---
        const createAnnouncementItem = (notice) => {
            const template = document.getElementById('announcementItemTemplate');
            const item = template.content.cloneNode(true).firstElementChild;

            item.dataset.noticeId = notice.notice_id;
            item.dataset.noticeData = JSON.stringify(notice);

            item.querySelector('.announcement-title').textContent = notice.title;
            item.querySelector('.announcement-content').textContent = notice.content || '(ë‚´ìš© ì—†ìŒ)';
            item.querySelector('.announcement-meta .branch').textContent = `ëŒ€ìƒ: ${notice.branch_name || 'ì „ì²´'}`;
            item.querySelector('.announcement-meta .date').textContent = `ì‘ì„±ì¼: ${formatDateTime(notice.created_at)}`;
            item.querySelector('.announcement-meta .author').textContent = `(ì‘ì„±ì: ${notice.created_by || 'ì•Œìˆ˜ì—†ìŒ'})`;

            // â­ï¸ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì€ ê´€ë¦¬ìì—ê²Œë§Œ ë³´ì´ë„ë¡
            if (isAdminUser()) {
                item.querySelector('.edit-btn').addEventListener('click', () => {
                    startEditAnnouncement(notice);
                });
                item.querySelector('.delete-btn').addEventListener('click', () => {
                    deleteAnnouncement(notice.notice_id, notice.title);
                });
            } else {
                item.querySelector('.announcement-actions').style.display = 'none';
            }

            return item;
        };

        // --- 3. ìƒˆ ê³µì§€ì‚¬í•­ ì €ì¥ ---
        const saveNewAnnouncement = async () => {
            const isAdmin = isAdminUser(); // ê´€ë¦¬ìì¸ì§€ í™•ì¸
            const title = noticeTitle.value.trim();
            const content = noticeContent.value.trim();
            // ê´€ë¦¬ìëŠ” ì„ íƒí•œ ì§€ì , ì¼ë°˜ ì‚¬ìš©ìëŠ” í•­ìƒ ""(ì „ì²´)
            const branch = isAdmin ? noticeBranch.value : "";

            if (!title) { showToast('ê³µì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.', false); noticeTitle.focus(); return; }

            saveNoticeBtn.disabled = true;
            saveNoticeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...';

            try {
                // ê´€ë¦¬ììš© ì¶”ê°€ API í˜¸ì¶œ (ë°±ì—”ë“œì—ì„œ ê¶Œí•œ ì²´í¬)
                await apiCall(`${SVR_JUNGSI}/jungsi/admin/student-announcements/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        target_branch: branch || null // "" ì´ë©´ null (ì „ì²´)
                    })
                });
                showToast('âœ… ìƒˆ ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
                resetForm();
                loadAnnouncements();
            } catch (err) {
                 // apiCallì—ì„œ 'ê¶Œí•œ ì—†ìŒ' ë“± ì—ëŸ¬ ë°œìƒ ì‹œ ì´ë¯¸ alert ë„ì›€
                 console.error('saveNewAnnouncement error caught:', err.message); // ì½˜ì†” ê¸°ë¡ë§Œ
            } finally {
                 saveNoticeBtn.disabled = false;
                 saveNoticeBtn.innerHTML = '<i class="fas fa-save"></i> ì €ì¥í•˜ê¸°';
            }
        };

        // --- 4. ê³µì§€ì‚¬í•­ ìˆ˜ì • ì‹œì‘ ---
        const startEditAnnouncement = (notice) => {
            if (!isAdminUser()) { showToast('ê³µì§€ì‚¬í•­ ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', false); return; }

            formTitle.textContent = 'ê³µì§€ì‚¬í•­ ìˆ˜ì •';
            editingNoticeId.value = notice.notice_id;
            noticeTitle.value = notice.title;
            noticeContent.value = notice.content || '';
            noticeBranch.value = notice.branch_name || '';
            noticeBranch.disabled = false; // ê´€ë¦¬ìëŠ” ì§€ì  ë³€ê²½ ê°€ëŠ¥
            saveNoticeBtn.innerHTML = '<i class="fas fa-edit"></i> ìˆ˜ì • ì™„ë£Œ';
            cancelEditBtn.style.display = 'inline-flex';
            announcementFormCard.scrollIntoView({ behavior: 'smooth' });
        };

        // --- 5. ê³µì§€ì‚¬í•­ ìˆ˜ì • ì €ì¥ ---
        const saveEditedAnnouncement = async () => {
            const noticeId = editingNoticeId.value;
            if (!isAdminUser()) { showToast('ê³µì§€ì‚¬í•­ ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', false); return; }

            const title = noticeTitle.value.trim();
            const content = noticeContent.value.trim();
            const branch = noticeBranch.value;

            if (!noticeId) { showToast('ìˆ˜ì •í•  ê³µì§€ IDê°€ ì—†ìŠµë‹ˆë‹¤.', false); return; }
            if (!title) { showToast('ê³µì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.', false); noticeTitle.focus(); return; }

            saveNoticeBtn.disabled = true;
            saveNoticeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìˆ˜ì • ì¤‘...';

            try {
                // ê´€ë¦¬ììš© ìˆ˜ì • API í˜¸ì¶œ
                await apiCall(`${SVR_JUNGSI}/jungsi/admin/student-announcements/update/${noticeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        target_branch: branch || null
                    })
                });
                showToast('âœ… ê³µì§€ì‚¬í•­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
                resetForm();
                loadAnnouncements();
            } catch (err) {
                 console.error('saveEditedAnnouncement error caught:', err.message);
            } finally {
                 saveNoticeBtn.disabled = false;
                 // resetFormì—ì„œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µêµ¬ë¨
            }
        };

        // --- 6. ê³µì§€ì‚¬í•­ ì‚­ì œ ---
        const deleteAnnouncement = async (noticeId, title) => {
            if (!isAdminUser()) { showToast('ê³µì§€ì‚¬í•­ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', false); return; }
            if (!confirm(`[${title}] ê³µì§€ì‚¬í•­ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { return; }

            try {
                // ê´€ë¦¬ììš© ì‚­ì œ API í˜¸ì¶œ
                await apiCall(`${SVR_JUNGSI}/jungsi/admin/student-announcements/delete/${noticeId}`, {
                    method: 'DELETE'
                });
                showToast('ğŸ—‘ï¸ ê³µì§€ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', true);
                loadAnnouncements();
            } catch (err) {
                 console.error('deleteAnnouncement error caught:', err.message);
            }
        };

        // --- 7. í¼ ì´ˆê¸°í™” í•¨ìˆ˜ ---
        const resetForm = () => {
            const isAdmin = isAdminUser();
            formTitle.textContent = 'ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„±';
            editingNoticeId.value = '';
            noticeTitle.value = '';
            noticeContent.value = '';
            noticeBranch.value = '';
            noticeBranch.disabled = !isAdmin; // ê´€ë¦¬ìë§Œ í™œì„±í™”
            saveNoticeBtn.innerHTML = '<i class="fas fa-save"></i> ì €ì¥í•˜ê¸°';
            saveNoticeBtn.disabled = false;
            cancelEditBtn.style.display = 'none';
        };

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        saveNoticeBtn.addEventListener('click', () => {
            if (editingNoticeId.value) {
                saveEditedAnnouncement();
            } else {
                saveNewAnnouncement();
            }
        });
        cancelEditBtn.addEventListener('click', resetForm); // ì·¨ì†Œ ë²„íŠ¼

        // --- ì´ˆê¸° ì‹¤í–‰ ---
        const initializePage = async () => {
             // â­ï¸ ìˆœì„œ ì¤‘ìš”: ê³µì§€ ëª©ë¡ ë¡œë“œ -> ì§€ì  ëª©ë¡ ë¡œë“œ (ì—­í• ë³„ ë¶„ê¸°)
            await loadAnnouncements(); // 1. ê³µì§€ ëª©ë¡ ë¡œë“œ (ì´ì œ ì„ ìƒë‹˜/ì›ì¥ë„ ê°€ëŠ¥)
            await loadBranches();      // 2. ì§€ì  ëª©ë¡ ë¡œë“œ (ê´€ë¦¬ìë§Œ API í˜¸ì¶œ)
            resetForm();               // 3. í¼ ì´ˆê¸°í™” (ì§€ì  ë“œë¡­ë‹¤ìš´ ìƒíƒœ ê²°ì • í›„)
        };
        initializePage();
    });
</script>

</body>
</html>